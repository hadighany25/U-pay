<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>U-PAY ADMIN PRO</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --primary: #004d40;
        --secondary: #00695c;
        --bg: #f0f2f5;
        --white: #fff;
        --text: #333;
        --success: #2ecc71;
        --danger: #e74c3c;
      }

      * {
        box-sizing: border-box;
        font-family: "Kantumruy Pro", sans-serif;
      }
      body {
        margin: 0;
        background: var(--bg);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* SIDEBAR */
      .sidebar {
        width: 260px;
        background: #1a1a1a;
        color: white;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: bold;
        color: #00b894;
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .menu-item {
        padding: 15px;
        color: #bbb;
        cursor: pointer;
        display: flex;
        gap: 15px;
        border-radius: 10px;
        transition: 0.3s;
        margin-bottom: 5px;
      }
      .menu-item:hover,
      .menu-item.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }
      .logout {
        margin-top: auto;
        background: #c0392b;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      }

      /* MAIN */
      .main {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
      }
      .page {
        display: none;
        animation: fadeIn 0.3s;
      }
      .page.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* DASHBOARD CARDS */
      .grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
      }
      .card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .card h3 {
        margin: 0;
        font-size: 2rem;
        color: #333;
      }
      .card p {
        margin: 0;
        color: #777;
        font-size: 0.9rem;
        font-weight: bold;
      }
      .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
      }

      /* TOGGLE SWITCH (Freeze) */
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #e74c3c;
      }
      input:checked + .slider:before {
        transform: translateX(24px);
      }

      /* TABLE */
      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      th {
        background: var(--primary);
        color: white;
        padding: 15px;
        text-align: left;
      }
      td {
        padding: 15px;
        border-bottom: 1px solid #eee;
      }

      .status-dot {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
      }
      .online {
        background-color: #2ecc71;
        box-shadow: 0 0 5px #2ecc71;
      }
      .offline {
        background-color: #ccc;
      }

      /* RECENT TRX LIST */
      .recent-trx {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin-top: 30px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      .trx-item {
        display: flex;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
      }
      .trx-item:last-child {
        border-bottom: none;
      }

      /* MODAL */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 400px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="logo">
        <i class="fa-solid fa-shield-halved"></i> U-PAY PRO
      </div>
      <div class="menu-item active" onclick="nav('dashboard', this)">
        <i class="fa-solid fa-chart-pie"></i> Dashboard
      </div>
      <div class="menu-item" onclick="nav('users', this)">
        <i class="fa-solid fa-users"></i> User Control
      </div>
      <div class="menu-item" onclick="nav('trx', this)">
        <i class="fa-solid fa-search"></i> Transactions
      </div>
      <button class="logout" onclick="logout()">Logout</button>
    </div>

    <div class="main">
      <div id="dashboard" class="page active">
        <h1 style="color: var(--primary)">System Overview</h1>
        <div class="grid-4">
          <div class="card">
            <div>
              <h3 id="d-users">0</h3>
              <p>Total Users</p>
            </div>
            <div class="icon-circle" style="background: #3498db">
              <i class="fa-solid fa-users"></i>
            </div>
          </div>
          <div class="card">
            <div>
              <h3 id="d-balance">$0.00</h3>
              <p>System Funds</p>
            </div>
            <div class="icon-circle" style="background: #2ecc71">
              <i class="fa-solid fa-wallet"></i>
            </div>
          </div>
          <div class="card">
            <div>
              <h3 id="d-trx">0</h3>
              <p>Transactions</p>
            </div>
            <div class="icon-circle" style="background: #f1c40f">
              <i class="fa-solid fa-exchange-alt"></i>
            </div>
          </div>
          <div class="card">
            <div>
              <h3 id="d-frozen">0</h3>
              <p>Frozen Accounts</p>
            </div>
            <div class="icon-circle" style="background: #e74c3c">
              <i class="fa-solid fa-lock"></i>
            </div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px">
          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 15px;
              box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            "
          >
            <h4>Transaction Volume</h4>
            <canvas id="myChart" style="height: 250px"></canvas>
          </div>
          <div class="recent-trx">
            <h4>Recent Activity</h4>
            <div id="recentList">
              <div style="text-align: center; color: #999; padding: 20px">
                Loading...
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="users" class="page">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h1>User Management</h1>
          <input
            type="text"
            id="searchBox"
            placeholder="Search Account..."
            onkeyup="filterUsers()"
            style="
              padding: 10px;
              width: 250px;
              border-radius: 5px;
              border: 1px solid #ccc;
            "
          />
        </div>
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Account</th>
              <th>Balance</th>
              <th>Status</th>
              <th>Freeze</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="userTable"></tbody>
        </table>
      </div>

      <div id="trx" class="page">
        <h1>Transaction Search</h1>
        <div
          style="
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
          "
        >
          <input
            type="text"
            id="trxInput"
            placeholder="Enter Transaction ID (e.g., TRX123...)"
            style="
              padding: 15px;
              width: 60%;
              border-radius: 8px;
              border: 1px solid #ddd;
              margin-right: 10px;
            "
          />
          <button
            onclick="searchTrx()"
            style="
              padding: 15px 30px;
              background: var(--primary);
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
            "
          >
            Search
          </button>
          <div id="trxResult" style="margin-top: 30px; text-align: left"></div>
        </div>
      </div>
    </div>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <h2 style="color: var(--primary); margin-top: 0">Edit User Info</h2>
        <input type="hidden" id="eid" />
        <input type="hidden" id="efrozen" />

        <p>
          <strong>Username:</strong>
          <input
            type="text"
            id="ename"
            style="
              width: 100%;
              padding: 10px;
              margin-top: 5px;
              border: 1px solid #ddd;
              border-radius: 5px;
            "
          />
        </p>

        <p>
          <strong>Account:</strong>
          <input
            type="text"
            id="eacc"
            style="
              width: 100%;
              padding: 10px;
              margin-top: 5px;
              border: 1px solid #ddd;
              border-radius: 5px;
              font-family: monospace;
              color: #004d40;
              font-weight: bold;
            "
          />
        </p>

        <p>
          <strong>Balance:</strong>
          <input
            type="number"
            id="ebal"
            style="
              width: 100%;
              padding: 10px;
              margin-top: 5px;
              border: 1px solid #ddd;
              border-radius: 5px;
            "
          />
        </p>

        <div style="text-align: right; margin-top: 20px">
          <button
            onclick="closeModal()"
            style="
              padding: 10px 20px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              background: #eee;
            "
          >
            Cancel
          </button>
          <button
            onclick="saveUser()"
            style="
              padding: 10px 20px;
              background: var(--primary);
              color: white;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              margin-left: 10px;
            "
          >
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <script>
      let allUsers = [];
      let allTrx = [];

      // NAVIGATION
      function nav(pageId, btn) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document.getElementById(pageId).classList.add("active");
        document
          .querySelectorAll(".menu-item")
          .forEach((m) => m.classList.remove("active"));
        if (btn) btn.classList.add("active");
      }

      // LOAD DATA
      async function loadData() {
        try {
          const res = await fetch("/api/users");
          allUsers = await res.json();

          let totalBal = 0;
          let frozenCount = 0;
          allTrx = [];

          allUsers.forEach((u) => {
            totalBal += u.balance || 0;
            if (u.isFrozen) frozenCount++;
            if (u.transactions) {
              u.transactions.forEach((t) =>
                allTrx.push({ ...t, senderName: u.username }),
              );
            }
          });

          allTrx.sort((a, b) => new Date(b.date) - new Date(a.date));

          // Stats
          document.getElementById("d-users").innerText = allUsers.length;
          document.getElementById("d-balance").innerText =
            "$" + totalBal.toFixed(2);
          document.getElementById("d-trx").innerText = allTrx.length;
          document.getElementById("d-frozen").innerText = frozenCount;

          renderUsers(allUsers);
          renderRecentTrx(allTrx.slice(0, 5));
        } catch (e) {
          console.error(e);
        }
      }

      // RENDER USERS
      function renderUsers(users) {
        const tbody = document.getElementById("userTable");
        if (document.activeElement.id === "searchBox") return;

        let html = "";
        users.forEach((u) => {
          const onlineHtml = u.isOnline
            ? `<span style="color:#2ecc71; font-weight:bold"><span class="status-dot online"></span>Online</span>`
            : `<span style="color:#999"><span class="status-dot offline"></span>Offline</span>`;

          const checked = u.isFrozen ? "checked" : "";
          const toggleHtml = `
                    <label class="switch">
                        <input type="checkbox" ${checked} onchange="toggleFreeze('${u._id}', this.checked)">
                        <span class="slider"></span>
                    </label>
                `;

          html += `
                    <tr>
                        <td><b>${u.username}</b></td>
                        <td style="font-family:monospace">${u.accountNumber}</td>
                        <td style="color:var(--primary); font-weight:bold">$${u.balance.toFixed(2)}</td>
                        <td>${onlineHtml}</td>
                        <td>${toggleHtml}</td>
                        <td>
                            <button onclick="openEdit('${u._id}', '${u.username}', '${u.accountNumber}', ${u.balance}, ${u.isFrozen})" style="cursor:pointer; padding:5px 10px; background:#f39c12; color:white; border:none; border-radius:5px;"><i class="fa-solid fa-pen"></i></button>
                        </td>
                    </tr>
                `;
        });
        tbody.innerHTML = html;
      }

      // RECENT TRANSACTIONS
      function renderRecentTrx(trxs) {
        const container = document.getElementById("recentList");
        let html = "";
        trxs.forEach((t) => {
          const color = t.amount < 0 ? "#e74c3c" : "#2ecc71";
          html += `
                    <div class="trx-item">
                        <div>
                            <div style="font-weight:bold">${t.type}</div>
                            <div style="font-size:0.8rem; color:#888">${t.date.split(",")[0]}</div>
                        </div>
                        <div style="color:${color}; font-weight:bold">$${Math.abs(t.amount).toFixed(2)}</div>
                    </div>
                `;
        });
        container.innerHTML =
          html || '<p style="text-align:center">No activities</p>';
      }

      // FREEZE TOGGLE
      async function toggleFreeze(id, isFrozen) {
        const user = allUsers.find((u) => u._id === id);
        await fetch("/api/admin/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: user._id,
            username: user.username,
            balance: user.balance,
            accountNumber: user.accountNumber,
            isFrozen: isFrozen,
          }),
        });
        loadData();
        const msg = isFrozen ? "Account Frozen ‚ùÑÔ∏è" : "Account Unfrozen üîì";
        const Toast = Swal.mixin({
          toast: true,
          position: "top-end",
          showConfirmButton: false,
          timer: 2000,
        });
        Toast.fire({ icon: isFrozen ? "warning" : "success", title: msg });
      }

      // EDIT LOGIC (Account Number Editable)
      function openEdit(id, name, acc, bal, frozen) {
        document.getElementById("eid").value = id;
        document.getElementById("ename").value = name;
        document.getElementById("eacc").value = acc; // ·û•·û°·ûº·ûú·û¢·û∂·ûÖ·ûÄ·üÇ·ûî·û∂·ûì
        document.getElementById("ebal").value = bal;
        document.getElementById("efrozen").value = frozen;
        document.getElementById("editModal").style.display = "flex";
      }
      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      async function saveUser() {
        const id = document.getElementById("eid").value;
        const username = document.getElementById("ename").value;
        const balance = document.getElementById("ebal").value;
        const accountNumber = document.getElementById("eacc").value; // ·ûô·ûÄ·ûè·ûò·üí·ûõ·üÉ·ûê·üí·ûò·û∏
        const isFrozen = document.getElementById("efrozen").value === "true";

        const res = await fetch("/api/admin/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id,
            username,
            balance,
            accountNumber,
            isFrozen,
          }),
        });
        const data = await res.json();

        if (data.success) {
          closeModal();
          loadData();
          Swal.fire("Success", "Updated Successfully!", "success");
        } else {
          Swal.fire("Error", "Update Failed", "error");
        }
      }

      // CHART (Dummy Data)
      const ctx = document.getElementById("myChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
          datasets: [
            {
              label: "Transactions ($)",
              data: [150, 230, 180, 320, 290, 450, 500],
              borderColor: "#004d40",
              tension: 0.4,
              fill: true,
              backgroundColor: "rgba(0, 77, 64, 0.1)",
            },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false },
      });

      // SEARCH TRX
      function searchTrx() {
        const id = document.getElementById("trxInput").value.trim();
        const t = allTrx.find((x) => x.refId === id);
        const resDiv = document.getElementById("trxResult");

        if (t) {
          resDiv.innerHTML = `
                    <div style="background:#e8f5e9; padding:20px; border-radius:10px; border-left:5px solid #2ecc71">
                        <h3 style="margin:0; color:#004d40;">Transaction Verified <i class="fa-solid fa-check-circle"></i></h3>
                        <p><b>ID:</b> ${t.refId}</p>
                        <p><b>Amount:</b> $${Math.abs(t.amount).toFixed(2)}</p>
                        <p><b>From:</b> ${t.senderName} -> <b>To:</b> ${t.partner || t.type}</p>
                        <p><b>Date:</b> ${t.date}</p>
                    </div>
                `;
        } else {
          resDiv.innerHTML = `<p style="color:red; font-weight:bold">‚ùå Transaction Not Found</p>`;
        }
      }

      // FILTER
      function filterUsers() {
        const q = document.getElementById("searchBox").value.toLowerCase();
        const rows = document.querySelectorAll("#userTable tr");
        rows.forEach((row) => {
          row.style.display = row.innerText.toLowerCase().includes(q)
            ? ""
            : "none";
        });
      }

      function logout() {
        localStorage.removeItem("user");
        location.href = "index.html";
      }

      loadData();
      setInterval(loadData, 5000);
    </script>
  </body>
</html>
